---
import Layout from '@/layouts/layout.astro';
import { getCollection, type CollectionEntry } from 'astro:content';
import Play from '@lucide/astro/icons/play';
import Clock from '@lucide/astro/icons/clock';
import Calendar from '@lucide/astro/icons/calendar';

const allVideos = await getCollection('videos');
const sortedVideos = allVideos.sort(
  (a: CollectionEntry<'videos'>, b: CollectionEntry<'videos'>) =>
    new Date(b.data.publishedDate).getTime() - new Date(a.data.publishedDate).getTime()
);

const categories = [
  { value: 'all', label: 'All' },
  { value: 'video', label: 'Videos' },
  { value: 'presentation', label: 'Presentations' },
  { value: 'webinar', label: 'Webinars' },
  { value: 'livestream', label: 'Livestreams' },
];

function getThumbnail(video: CollectionEntry<'videos'>) {
  return video.data.thumbnail || `https://img.youtube.com/vi/${video.data.youtubeId}/mqdefault.jpg`;
}
---

<Layout title="Videos">
  <div class="container mx-auto px-6 py-12">
    <h1 class="text-4xl font-bold mb-2">Videos</h1>
    <p class="text-muted-foreground mb-10">
      Talks, tutorials, and other video content.
    </p>

    <!-- Category filters -->
    <div class="flex flex-wrap gap-2 mb-8" id="category-filters">
      {
        categories.map(({ value, label }) => (
          <button
            data-filter={value}
            class:list={[
              'px-4 py-2 rounded-lg text-sm font-medium transition-colors cursor-pointer',
              value === 'all'
                ? 'bg-primary text-primary-foreground'
                : 'glass-strong border border-border text-muted-foreground hover:text-primary hover:border-primary/50',
            ]}
          >
            {label}
          </button>
        ))
      }
    </div>

    <!-- Video grid -->
    <div class="grid gap-8 md:grid-cols-2" id="video-grid">
      {
        sortedVideos.map((video) => (
          <article
            class="video-card group glass-strong rounded-2xl border border-border overflow-hidden transition-all duration-700 hover:shadow-lg hover:shadow-primary/5 opacity-0 translate-y-4 scale-[0.97]"
            data-category={video.data.category}
          >
            {/* Thumbnail with play overlay */}
            <a
              href={`https://www.youtube.com/watch?v=${video.data.youtubeId}`}
              target="_blank"
              rel="noopener noreferrer"
              class="block relative overflow-hidden"
            >
              <img
                src={getThumbnail(video)}
                alt={video.data.title}
                class="w-full aspect-video object-cover scale-110 transition-transform duration-700 group-[.visible]:scale-100 group-hover:scale-105"
                loading="lazy"
              />
              <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                <div class="bg-primary/90 rounded-full p-4">
                  <Play class="w-8 h-8 text-primary-foreground fill-current" />
                </div>
              </div>
            </a>

            <div class="p-5 space-y-3">
              {/* Meta row */}
              <div class="flex flex-wrap items-center gap-2 text-sm">
                {video.data.event && (
                  <span class="text-muted-foreground">{video.data.event}</span>
                )}
                {video.data.duration && (
                  <span class="flex items-center gap-1 text-muted-foreground ml-auto">
                    <Clock class="w-3.5 h-3.5" />
                    {video.data.duration}
                  </span>
                )}
              </div>

              {/* Title */}
              <a
                href={`https://www.youtube.com/watch?v=${video.data.youtubeId}`}
                target="_blank"
                rel="noopener noreferrer"
                class="text-xl font-semibold text-foreground group-hover:text-primary transition-colors block leading-snug"
              >
                {video.data.title}
              </a>

              {/* Date */}
              <p class="flex items-center gap-1.5 text-sm text-muted-foreground">
                <Calendar class="w-3.5 h-3.5" />
                {video.data.publishedDate.toLocaleDateString(undefined, {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric',
                })}
              </p>

              {/* Description */}
              <p class="text-muted-foreground text-sm leading-relaxed">
                {video.data.description}
              </p>

              {/* Tags */}
              {video.data.tags && video.data.tags.length > 0 && (
                <div class="flex flex-wrap gap-1.5 pt-1">
                  {video.data.tags.map((tag: string) => (
                    <span class="px-2 py-0.5 rounded text-xs bg-primary/10 text-primary">
                      {tag}
                    </span>
                  ))}
                </div>
              )}
            </div>
          </article>
        ))
      }
    </div>
  </div>
</Layout>

<script>
  document.addEventListener('astro:page-load', () => {
    const filters = document.getElementById('category-filters');
    const grid = document.getElementById('video-grid');
    if (!filters || !grid) return;

    const buttons = filters.querySelectorAll<HTMLButtonElement>('[data-filter]');
    const cards = grid.querySelectorAll<HTMLElement>('[data-category]');

    // Animate cards in when they enter the viewport
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const card = entry.target as HTMLElement;
            const siblings = Array.from(grid.querySelectorAll('[data-category]:not([style*="display: none"])'));
            const visibleIdx = siblings.indexOf(card) % 2;
            const delay = visibleIdx * 120;
            setTimeout(() => {
              card.classList.add('visible');
              card.classList.remove('opacity-0', 'translate-y-4', 'scale-[0.97]');
            }, delay);
            observer.unobserve(card);
          }
        });
      },
      { threshold: 0.1 }
    );

    function observeVisibleCards() {
      cards.forEach((card) => {
        if (card.style.display !== 'none') {
          if (!card.classList.contains('visible')) {
            observer.observe(card);
          }
        }
      });
    }

    observeVisibleCards();

    buttons.forEach((btn) => {
      btn.addEventListener('click', () => {
        const filter = btn.dataset.filter!;

        // Update active button styles
        buttons.forEach((b) => {
          if (b === btn) {
            b.classList.add('bg-primary', 'text-primary-foreground');
            b.classList.remove(
              'glass-strong',
              'border',
              'border-border',
              'text-muted-foreground'
            );
          } else {
            b.classList.remove('bg-primary', 'text-primary-foreground');
            b.classList.add(
              'glass-strong',
              'border',
              'border-border',
              'text-muted-foreground'
            );
          }
        });

        // Show/hide cards and reset animation for newly shown cards
        cards.forEach((card) => {
          if (filter === 'all' || card.dataset.category === filter) {
            card.style.display = '';
            if (!card.classList.contains('visible')) {
              card.classList.add('opacity-0', 'translate-y-4', 'scale-[0.97]');
            }
          } else {
            card.style.display = 'none';
          }
        });

        observeVisibleCards();
      });
    });
  });
</script>
