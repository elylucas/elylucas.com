---
import Layout from '@/layouts/layout.astro';
import { getCollection, type CollectionEntry } from 'astro:content';
import Calendar from '@lucide/astro/icons/calendar';
import ArrowRight from '@lucide/astro/icons/arrow-right';

const blogPosts = await getCollection('blog');
const sortedPosts = blogPosts.sort(
  (a: CollectionEntry<'blog'>, b: CollectionEntry<'blog'>) =>
    new Date(b.data.publishedDate).getTime() -
    new Date(a.data.publishedDate).getTime()
);

const PAGE_SIZE = 10;

function postHref(post: CollectionEntry<'blog'>) {
  return `/blog/${post.id.replace('.md', '')}`;
}
---

<Layout>
  <section class="container mx-auto px-6 py-12">
    <h1 class="text-4xl font-bold mb-2">Blog</h1>
    <p class="text-muted-foreground mb-10">
      Thoughts on web development, mobile, and the tools I use.
    </p>

    <div class="grid gap-8 md:grid-cols-2" id="post-grid">
      {
        sortedPosts.map((post, idx) => (
          <article
            class:list={[
              'group glass-strong rounded-2xl border border-border overflow-hidden transition-shadow hover:shadow-lg hover:shadow-primary/5',
              idx >= PAGE_SIZE && 'hidden',
            ]}
            data-post-index={idx}
          >
            {/* Cover image */}
            <a href={postHref(post)} class="block overflow-hidden">
              {post.data.coverImage ? (
                <img
                  src={post.data.coverImage}
                  alt={post.data.title}
                  class="w-full aspect-[16/9] object-cover transition-transform duration-300 group-hover:scale-105"
                  loading={idx < 4 ? 'eager' : 'lazy'}
                />
              ) : (
                <div class="w-full aspect-[16/9] bg-gradient-to-br from-primary/20 to-primary/5 flex items-center justify-center">
                  <span class="text-4xl font-bold text-primary/30 select-none">
                    {post.data.title.charAt(0)}
                  </span>
                </div>
              )}
            </a>

            <div class="p-5 space-y-3">
              {/* Date */}
              <p class="flex items-center gap-1.5 text-sm text-muted-foreground">
                <Calendar class="w-3.5 h-3.5" />
                {post.data.publishedDate.toLocaleDateString(undefined, {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric',
                })}
              </p>

              {/* Title */}
              <a
                href={postHref(post)}
                class="text-xl font-semibold text-foreground group-hover:text-primary transition-colors block leading-snug"
              >
                {post.data.title}
              </a>

              {/* Summary */}
              <p class="text-muted-foreground text-sm line-clamp-3 leading-relaxed">
                {post.data.summary}
              </p>

              {/* Read more */}
              <a
                href={postHref(post)}
                class="inline-flex items-center gap-1 text-sm font-medium text-primary hover:underline pt-1"
              >
                Read more
                <ArrowRight class="w-3.5 h-3.5" />
              </a>
            </div>
          </article>
        ))
      }
    </div>

    {/* Load more button */}
    {
      sortedPosts.length > PAGE_SIZE && (
        <div class="flex justify-center mt-12" id="load-more-wrapper">
          <button
            id="load-more-btn"
            class="px-6 py-3 rounded-lg font-medium glass-strong border border-border text-muted-foreground hover:text-primary hover:border-primary/50 transition-colors cursor-pointer"
          >
            Load more posts
          </button>
        </div>
      )
    }
  </section>
</Layout>

<script define:vars={{ PAGE_SIZE }}>
  document.addEventListener('astro:page-load', () => {
    const grid = document.getElementById('post-grid');
    const btn = document.getElementById('load-more-btn');
    const wrapper = document.getElementById('load-more-wrapper');
    if (!grid || !btn || !wrapper) return;

    let visible = PAGE_SIZE;
    const allCards = grid.querySelectorAll('[data-post-index]');
    const total = allCards.length;

    btn.addEventListener('click', () => {
      const nextVisible = Math.min(visible + PAGE_SIZE, total);
      for (let i = visible; i < nextVisible; i++) {
        allCards[i].classList.remove('hidden');
      }
      visible = nextVisible;
      if (visible >= total) {
        wrapper.style.display = 'none';
      }
    });
  });
</script>
